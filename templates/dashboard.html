<!DOCTYPE html><html><head><title>AI Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>.chat-box{height:300px;overflow-y:auto;background:#f1f1f1;padding:10px;border-radius:10px;margin-bottom:10px}</style>
</head><body class="bg-light"><div class="container py-5">
<h2>Salut, {{ session['user_nume'] }}!</h2>
<a href="/logout" class="btn btn-sm btn-danger mb-3">Logout</a>

<div class="chat-box" id="chatBox"></div>
<div class="input-group mb-3">
<input id="mesaj" class="form-control" placeholder="Scrie un mesaj...">
<button class="btn btn-primary" onclick="trimite()">Trimite</button>
<button class="btn btn-success" onclick="vorbeste()">🎤</button>
</div>

<h5 class="mt-5">🗂️ Istoric conversații:</h5>
<div class="mb-3 d-flex justify-content-between">
    <input id="searchBox" onkeyup="filtreaza()" class="form-control w-50" placeholder="Caută în mesaje...">
    <div>
        <a href="/export_csv" class="btn btn-outline-secondary btn-sm">📄 CSV</a>
        <a href="/export_pdf" class="btn btn-outline-secondary btn-sm">🧾 PDF</a>
    </div>
</div>
<table class="table table-sm table-striped bg-white"><thead><tr><th>Mesaj</th><th>Răspuns</th><th>Data</th></tr></thead><tbody>
{% for c in conversatii %}
<tr><td>{{ c.mesaj }}</td><td>{{ c.raspuns }}</td><td>{{ c.data_ora }}</td></tr>
{% endfor %}
</tbody></table>

<h5>📅 Evenimente:</h5>
<table class="table table-bordered bg-white"><thead><tr><th>Mesaj</th><th>Data</th></tr></thead><tbody>
{% for ev in evenimente %}<tr><td>{{ ev.mesaj }}</td><td>{{ ev.data_ora }}</td></tr>{% endfor %}
</tbody></table>
</div>

<script>
function adauga(tip, text){
  const box=document.getElementById("chatBox");
  const d=document.createElement("div");
  d.innerHTML=`<b>${tip==="user"?"Tu":"AI"}:</b> ${text}`; box.appendChild(d); box.scrollTop=box.scrollHeight;
}
function trimite(){
  const m=document.getElementById("mesaj").value; if(!m)return;
  adauga("user", m); document.getElementById("mesaj").value="";
  fetch("/ai",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mesaj:m})})
  .then(r=>r.json()).then(d=>{ adauga("ai", d.raspuns); let s=new SpeechSynthesisUtterance(d.raspuns);s.lang="ro-RO";speechSynthesis.speak(s); });
}
function vorbeste(){
  const rec=new webkitSpeechRecognition(); rec.lang="ro-RO"; rec.start();
  rec.onresult=(e)=>{ document.getElementById("mesaj").value=e.results[0][0].transcript; trimite(); };
}
</script></body></html>
<script>
function filtreaza(){
    let input = document.getElementById("searchBox").value.toLowerCase();
    let rows = document.querySelectorAll("table tbody tr");
    rows.forEach(r => {
        r.style.display = r.innerText.toLowerCase().includes(input) ? "" : "none";
    });
}
</script>
